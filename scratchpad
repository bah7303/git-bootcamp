

SELECT PH.portfolio_code,
       nav_asof = PH.data_asof_time ,
       PH.value 
FROM 
(  SELECT PHX.portfolio_code, 
        --    PHX.value, 
           PHX.port_date,
            MAX(PHX.data_asof_time) AS 'change_date'
    FROM 
    ( 
         -- NAV 
         SELECT PH1.portfolio_code, 
                PH1.port_date, -- PH1.*,
               MIN(PHI1.group_order) as 'group_order',
                PH1.datatype
         FROM ( SELECT PH.portfolio_code, 
                       MAX(PH.port_date) as 'max_date' 
                 FROM ( 
                         SELECT portfolio_code /* This is where you would put in the port values. */ 
                        FROM portdb.dbo.portfolios /* This is where you would put in the port values. */ 
                        WHERE portfolio_code IN (154262, 12444, 16913, 10498, 160372, 160861, 160863, 18292, 34132, 26142)) P     /*  This is where you would put in the port values. */
                     --   WHERE contract_id = 3218) P /* This is where you would put in the port values. */ 
                 INNER JOIN portdb.dbo.port_hist PH ON P.portfolio_code = PH.portfolio_code 
                 GROUP BY PH.portfolio_code) AS P1 
         INNER JOIN portdb.dbo.port_hist PH1 ON P1.portfolio_code = PH1.portfolio_code 
                                                AND P1.max_date = PH1.port_date 
         LEFT OUTER JOIN pricedb.dbo.price_hierarchy PHI1 ON PH1.datatype = PHI1.purpose 
                                                 AND  PHI1.price_group = 'PKGNAV' 
         WHERE PH1.value != null 
         GROUP BY PH1.portfolio_code, 
                  PH1.port_date
     ) X 
     INNER JOIN portdb.dbo.port_hist PHX ON X.portfolio_code = PHX.portfolio_code 
                                            AND X.port_date = PHX.port_date 
                                            AND X.datatype = PHX.datatype
      LEFT OUTER JOIN pricedb.dbo.price_hierarchy PHI1X ON X.group_order = PHI1X.group_order
                                                           AND PHX.datatype = PHI1X.purpose     
                                                           AND  PHI1X.price_group = 'PKGNAV' 
      GROUP BY PHX.portfolio_code,    
              PHX.port_date 
--order by PHX.portfolio_code, PHX.change_date
) XX 
INNER JOIN  portdb.dbo.port_hist PH ON PH.portfolio_code = XX.portfolio_code
       AND PH.port_date = XX.port_date 
       AND PH.data_asof_time =  XX.change_date

	   
	   
	   
	   
	   
	   
	   
	   
	   
	   SELECT PHX.portfolio_code,
        PHX.port_date,
         MAX(PHX.data_asof_time) as 'data_asof_time' 
FROM
(


        SELECT PH.portfolio_code, 
               MAX(PH.port_date) as 'port_date' 
        FROM ( 
              SELECT portfolio_code /* This is where you would put in the port values. */ 
             FROM portdb.dbo.portfolios /* This is where you would put in the port values. */ 
             WHERE portfolio_code IN (154262, 12444, 16913, 10498, 160372, 160861, 160863, 18292, 34132, 26142)) P     /*  This is where you would put in the port values. */
          --   WHERE contract_id = 3218) P /* This is where you would put in the port values. */ 
        INNER JOIN portdb.dbo.port_hist PH ON P.portfolio_code = PH.portfolio_code 
        GROUP BY PH.portfolio_code

) X 
INNER JOIN portdb.dbo.port_hist PHX ON X.portfolio_code = PHX.portfolio_code
                                       AND X.port_date = PHX.port_date
GROUP BY PHX.portfolio_code,
        PHX.port_date